<van-toast id="van-toast" />

<!-- 自定义导航栏 -->
<view class="header-wrap" style="height: {{navBarHeight}}px; padding-top: {{statusBarHeight}}px;">
  <view class="nav-left" bindtap="onNavBack">
    <view class="nav-back-btn">
      <text class="nav-back">‹</text>
    </view>
  </view>
  <view class="nav-center">
    <text class="nav-title">我的订单</text>
  </view>
  <view class="nav-right"></view>
</view>

<view class="order-page" style="padding-top: {{navBarHeight}}px;">
  <van-tabs active="{{activeTab}}" color="rgb(139, 90, 43)" line-width="60rpx" line-height="6rpx"
    title-active-color="rgb(139, 90, 43)" title-inactive-color="rgba(43,43,43,0.65)" bind:change="onTabChange">
    <van-tab title="全部" name="all" />
    <van-tab title="待支付" name="pending_pay" />
    <van-tab title="待核销" name="pending_verify" />
    <van-tab title="已完成" name="done" />
    <van-tab title="售后/退款" name="after_sale" />
  </van-tabs>

  <scroll-view scroll-y class="list-scroll" lower-threshold="80" bindscrolltolower="onReachBottom"
    refresher-enabled="true" refresher-triggered="{{refreshing}}" bindrefresherrefresh="onRefresh">
    <view class="list-wrap">
      <block wx:if="{{loading && !list.length}}">
        <view class="skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
          <view class="skeleton-cover"></view>
          <view class="skeleton-right">
            <view class="skeleton-line skeleton-line--lg"></view>
            <view class="skeleton-line"></view>
            <view class="skeleton-line skeleton-line--sm"></view>
          </view>
        </view>
      </block>

      <block wx:elif="{{list.length}}">
        <view class="order-card-item" wx:for="{{list}}" wx:key="order_id">
          <view class="item-top">
            <view class="left">
              <van-tag type="warning" custom-class="source-tag">{{item.source === 'service' ? '服务' : '拼团'}}</van-tag>
              <text class="status-text">{{item.status_text}}</text>
            </view>
            <text class="order-no">订单号：{{item.order_no}}</text>
          </view>
          <view class="item-body">
            <van-image class="cover" width="160rpx" height="160rpx" fit="cover" src="{{item.cover}}" />
            <view class="info">
              <text class="title">{{item.title}}</text>
              <view class="meta-row">
                <text class="price">¥{{item.price}}</text>
                <text class="qty">x{{item.quantity}}</text>
              </view>
              <view class="meta-row">
                <text class="time">{{item.create_time}}</text>
              </view>
            </view>
          </view>
          <view class="item-footer">
            <text class="pay-amount">实付：¥{{item.pay_amount}}</text>
            <view class="actions">
              <van-button size="small" type="default" plain custom-class="action-btn" wx:if="{{item.status==='pending_pay'}}"
                bind:click="onPay" data-id="{{item.order_id}}">去支付</van-button>
              <van-button size="small" type="primary" custom-class="action-btn" wx:if="{{item.status==='pending_verify' && item.source==='service'}}"
                bind:click="onShowVerify" data-id="{{item.order_id}}">查看核销码</van-button>
              <van-button size="small" type="default" plain custom-class="action-btn" wx:if="{{item.status==='done'}}"
                bind:click="onRebuy" data-id="{{item.order_id}}">再次购买</van-button>
              <van-button size="small" type="default" plain custom-class="action-btn" wx:if="{{item.status==='after_sale' || item.status==='refund_pending'}}"
                bind:click="onAfterSale" data-id="{{item.order_id}}">售后进度</van-button>
            </view>
          </view>
        </view>
      </block>

      <block wx:else>
        <van-empty description="暂无订单" />
      </block>
    </view>
  </scroll-view>
</view>

<!-- 核销码弹窗 -->
<van-popup show="{{verifyPopup.show}}" bind:close="closeVerifyPopup" round position="bottom" custom-style="padding: 24rpx 24rpx 32rpx;">
  <view class="verify-popup">
    <view class="verify-title">核销码</view>
    <view class="verify-code">{{verifyPopup.code}}</view>
    <view class="verify-qr">
      <van-image width="220rpx" height="220rpx" fit="contain" src="{{verifyPopup.qr}}" />
    </view>
    <view class="verify-tip">请向商家出示核销码或二维码完成核销</view>
  </view>
</van-popup>

